<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>AI-Content-Engine</title>
  <meta name="viewport" content="width=600, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Input Panel -->
    <div class="compact-panel">
      <img src="assets/logo.png" alt="Expoya Logo" class="logo">
      <h2 class="headline">AI-Content-Engine</h2>
      <form id="myForm" autocomplete="off">
        <div class="form-group">
          <input type="text" name="companyName" placeholder="Unternehmensname" required>
        </div>
        <div class="form-group">
          <input type="url" name="website" placeholder="Website">
        </div>
        <div class="form-row">
          <input type="number" name="expoCount" placeholder="# Expos" min="1" max="100" required style="flex:2;">
          <select id="brancheSelect" name="branche" required style="flex:3;">
            <option value="">‚Äì w√§hlen ‚Äì</option>
          </select>
        </div>
        <div class="form-group">
          <textarea name="regionen" placeholder="Regionen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielgruppen" placeholder="Zielgruppen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="produkte" placeholder="Produkte / DL (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielsetzung" placeholder="Zielsetzung der Expos (z.‚ÄØB. 'Mehr Leads f√ºr regionale Dienstleistung')" rows="2"></textarea>
        </div>
        <div class="form-group tonality-container">
          <label class="tonality-label" for="tonality">Tonalit√§t</label>
          <input type="range" min="1" max="5" value="3" class="tonality-slider" id="tonality" name="tonality">
          <div class="tonality-value" id="tonality-value">Neutral</div>
        </div>
        <div class="form-group toggles-row">
          <div class="toggle-combo">
            <span class="toggle-label">Mit Ortsbezug</span>
            <label class="switch switch-small">
              <input type="checkbox" id="mitOrtsbezug" name="mitOrtsbezug" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-combo">
            <span class="toggle-label">Ansprache</span>
            <label class="switch switch-small">
              <input type="checkbox" id="ansprache" name="ansprache" checked>
              <span class="slider"></span>
            </label>
            <span class="toggle-label" id="ansprache-label">Du</span>
          </div>
        </div>
        <button class="btn-primary" type="submit">üöÄ Generieren</button>
      </form>
    </div>

    <!-- Output Panel -->
    <div class="output-panel" id="outputPanel">
      <h3 class="output-headline">üìù Generierte Expo-Titel</h3>
      <ul class="expo-list" id="expoList">
        <li class="expo-placeholder">Hier erscheinen deine generierten Expo-Titel...</li>
      </ul>
      <button id="exportBtn" class="btn-primary" style="margin-top:18px;display:none;">Export als CSV</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Branchen dynamisch aus JSON laden (robust & ohne Duplikate)
      async function ladeBranchen() {
        const select = document.getElementById('brancheSelect');
        select.innerHTML = '<option value="">‚Äì w√§hlen ‚Äì</option>'; // Immer leeren!
        try {
          const response = await fetch('assets/gmb_categories.json');
          if (!response.ok) throw new Error("JSON konnte nicht geladen werden");
          const categories = await response.json();
          categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            select.appendChild(opt);
          });
        } catch (err) {
          // Fallback
          ['Apotheke','Architekt','B√§ckerei'].forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            select.appendChild(opt);
          });
          // Info im Select
          select.insertAdjacentHTML('beforebegin', `<div style="color:#ff7070;font-size:13px;margin-bottom:3px;">Kategorien konnten nicht geladen werden.</div>`);
        }
      }
      await ladeBranchen();


      const tonalities = ['Locker', 'Eher locker', 'Neutral', 'Eher formell', 'Sehr formell'];
      const tonalityInput = document.getElementById('tonality');
      const tonalityValue = document.getElementById('tonality-value');
      tonalityInput.addEventListener('input', function() {
        tonalityValue.innerText = tonalities[this.value - 1];
      });

      const anspracheInput = document.getElementById('ansprache');
      const anspracheLabel = document.getElementById('ansprache-label');
      anspracheInput.addEventListener('change', function() {
        anspracheLabel.innerText = this.checked ? 'Du' : 'Sie';
      });

      const ladeFloskeln = [
        "Die AI-Agents h√ºpfen im Quadrat, um geile Titel zu basteln‚Ä¶",
        "Unsere KI brainstormt gerade die wildesten Expo-Ideen.",
        "Es werden noch schnell ein paar Synapsen poliert‚Ä¶",
        "Gleich sind die besten Titel aus dem neuronalen Backofen!",
        "Die k√ºnstliche Intelligenz schreibt schon am Bestseller.",
        "Wir optimieren noch f√ºr Google ‚Äì bitte einen kurzen Espresso trinken!",
        "Noch ein Moment: Kreativit√§t braucht manchmal eine kurze Denkpause.",
        "Die AI schraubt noch am SEO-Schraubenzieher.",
        "Expoya-Titelschmiede l√§uft auf Hochtouren!",
        "Wir w√ºrfeln noch ein paar W√∂rter zusammen‚Ä¶"
      ];

      let expoTitelArray = [];
      let pollTimer;

      document.getElementById("myForm").addEventListener("submit", async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        data['mitOrtsbezug'] = document.getElementById('mitOrtsbezug').checked;
        data['ansprache'] = document.getElementById('ansprache').checked ? 'Du' : 'Sie';
        data['tonality'] = tonalities[parseInt(formData.get('tonality')) - 1];

        const list = document.getElementById("expoList");
        list.innerHTML = '';
        const liWait = document.createElement("li");
        liWait.textContent = "üöÄ Generierung l√§uft...";
        liWait.className = "expo-placeholder";
        list.appendChild(liWait);
        document.getElementById('exportBtn').style.display = "none";

        // STEP 1: Starte Job
        const jobUrl = "https://expoya.app.n8n.cloud/webhook/start-job";
        let jobId;
        try {
          const response = await fetch(jobUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
          const result = await response.json();
          jobId = result.jobId;
          if (!jobId) throw new Error("Keine Job-ID erhalten!");
        } catch (e) {
          list.innerHTML = `<li>Fehler: ${e.message}</li>`;
          return;
        }

        // STEP 2: Polling mit Ladefeedback
        const pollUrl = "https://expoya.app.n8n.cloud/webhook/get-job?jobId=" + encodeURIComponent(jobId);
        let pollTries = 0;
        const maxPolls = 90; // max. 15 Minuten bei 10 Sek Intervall
        const startedAt = Date.now();
        let generationComplete = false;

        pollTimer = setInterval(async () => {
          pollTries++;
          const seconds = Math.floor((Date.now() - startedAt) / 1000);
          const floskelIndex = Math.floor(seconds / 10) % ladeFloskeln.length;
          const floskel = ladeFloskeln[floskelIndex];
          // Ladefeedback
          list.innerHTML = `
            <li class="expo-placeholder">
              üöÄ Generierung l√§uft... (${seconds} Sekunden)<br>
              <span style="font-size:0.98em;color:#98a4c2;">${floskel}</span>
            </li>
          `;
          try {
            const res = await fetch(pollUrl);
            const job = await res.json();

            if (job.status === "finished" && job.result) {
              clearInterval(pollTimer);
              generationComplete = true;
              list.innerHTML = "";
              try {
                expoTitelArray = JSON.parse(job.result);
              } catch (err) {
                expoTitelArray = [];
              }
              if (expoTitelArray.length === 0) {
                list.innerHTML = `<li>Es wurden keine Titel generiert.</li>`;
              } else {               
        renderExpoListe();
              }
            } else if (job.status === "error") {
              clearInterval(pollTimer);
              generationComplete = true;
              list.innerHTML = `<li>Fehler: ${job.error || "Unbekannter Fehler."}</li>`;
            }
          } catch (e) {
            clearInterval(pollTimer);
            generationComplete = true;
            list.innerHTML = `<li>Polling-Fehler: ${e.message}</li>`;
          }
          if (pollTries > maxPolls && !generationComplete) {
            list.innerHTML = `<li>Timeout: Die Generierung hat zu lange gedauert.</li>`;
            clearInterval(pollTimer);
          }
        }, 10000); // alle 10 Sekunden
      });

      // CSV-Export-Funktion
      document.getElementById('exportBtn').addEventListener('click', function() {
        if (!expoTitelArray || expoTitelArray.length === 0) return;
        let csv = 'Expo-Titel\n';
        expoTitelArray.forEach(titel => {
          let safeTitel = titel.replace(/"/g, '""').replace(/\r?\n|\r/g, ' ');
          csv += `"${safeTitel}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'expo-titel.csv';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

function renderExpoListe() {
  const list = document.getElementById("expoList");
  list.innerHTML = "";
  if (expoTitelArray.length === 0) {
    list.innerHTML = `<li class="expo-placeholder">Keine Titel mehr vorhanden.</li>`;
    document.getElementById('exportBtn').style.display = "none";
    return;
  }
  expoTitelArray.forEach((titel, idx) => {
    const item = document.createElement("li");
    item.className = "expo-akkordeon";
    item.innerHTML = `
      <div class="expo-akk-header" data-idx="${idx}">
        <span class="expo-akk-index">${idx + 1}.</span>
        <span class="expo-akk-titel"><span class="expo-titel-text">${titel}</span></span>
        <button class="btn-icon btn-edit" title="Bearbeiten" data-idx="${idx}">‚úèÔ∏è</button>
        <button class="btn-icon btn-delete" title="Entfernen" data-idx="${idx}">üóëÔ∏è</button>
        <button class="btn-expand" title="Details anzeigen" data-idx="${idx}">‚ñº</button>
      </div>
      <div class="expo-akk-body">
        <input class="edit-titel-input" value="${titel}" style="display:none;">
        <div class="akk-btns">
          <button class="btn-save" style="display:none;" data-idx="${idx}">Speichern</button>
          <button class="btn-generate" data-idx="${idx}">Text generieren</button>
        </div>
      </div>
    `;
    list.appendChild(item);
  });

  // Accordion Mechanik
  list.querySelectorAll('.btn-expand').forEach(btn => {
    btn.onclick = function(e) {
      e.stopPropagation();
      const parent = btn.closest(".expo-akkordeon");
      const wasOpen = parent.classList.contains("open");
      // Erst alle schlie√üen
      list.querySelectorAll('.expo-akkordeon').forEach(el => {
        el.classList.remove("open");
        el.querySelector('.btn-expand').textContent = "‚ñº";
        // Zur√ºcksetzen Editmode im Body:
        el.querySelector('.edit-titel-input').style.display = "none";
        el.querySelector('.btn-save').style.display = "none";
        el.querySelector('.expo-titel-text').style.display = "inline";
      });
      // Dann ggf. das aktuelle √∂ffnen
      if (!wasOpen) {
        parent.classList.add("open");
        btn.textContent = "‚ñ≤";
      }
    };
  });

  // Bearbeiten
  list.querySelectorAll('.btn-edit').forEach(btn => {
    btn.onclick = function(e) {
      e.stopPropagation();
      const parent = btn.closest(".expo-akkordeon");
      parent.classList.add("open");
      parent.querySelector('.btn-expand').textContent = "‚ñ≤";
      // Nur Editmodus f√ºr diesen Titel:
      parent.querySelector('.edit-titel-input').style.display = "inline";
      parent.querySelector('.btn-save').style.display = "inline-block";
      parent.querySelector('.expo-titel-text').style.display = "none";
      parent.querySelector('.edit-titel-input').focus();
    };
  });

  // Speichern
  list.querySelectorAll('.btn-save').forEach(btn => {
    btn.onclick = function(e) {
      e.stopPropagation();
      const idx = this.getAttribute("data-idx");
      const parent = btn.closest(".expo-akkordeon");
      const val = parent.querySelector('.edit-titel-input').value.trim();
      if (val.length === 0) return;
      expoTitelArray[idx] = val;
      renderExpoListe();
      // Offen lassen!
      setTimeout(()=>{
        const acc = list.querySelectorAll('.expo-akkordeon')[idx];
        acc.classList.add("open");
        acc.querySelector('.btn-expand').textContent = "‚ñ≤";
      },0);
    };
  });

  // L√∂schen
  list.querySelectorAll('.btn-delete').forEach(btn => {
    btn.onclick = function(e) {
      e.stopPropagation();
      const idx = this.getAttribute("data-idx");
      expoTitelArray.splice(idx, 1);
      renderExpoListe();
    };
  });

  // Text generieren
  list.querySelectorAll('.btn-generate').forEach(btn => {
    btn.onclick = function(e) {
      e.stopPropagation();
      const idx = this.getAttribute("data-idx");
      alert("Text f√ºr Expo-Titel " + (parseInt(idx)+1) + " generieren!\n\n(Titel: " + expoTitelArray[idx] + ")");
      // Hier kommt sp√§ter dein n8n-Call!
    };
  });

   

  // Export-Button nur anzeigen, wenn Titel vorhanden
  document.getElementById('exportBtn').style.display = expoTitelArray.length > 0 ? "block" : "none";
}

    }); // DOMContentLoaded-Ende
  </script>
</body>
</html>
