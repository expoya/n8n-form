<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>AI-Content-Engine</title>
  <meta name="viewport" content="width=600, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Input Panel -->
    <div class="compact-panel">
      <img src="assets/logo.png" alt="Expoya Logo" class="logo">
      <h2 class="headline">AI-Content-Engine</h2>

      <form id="myForm" autocomplete="off">
        <div class="form-group">
          <input type="text" name="companyName" placeholder="Unternehmensname" required>
        </div>
        <div class="form-group">
          <input type="url" name="website" placeholder="Website">
        </div>
        <div class="form-row">
          <input type="number" name="expoCount" placeholder="# Expos" min="1" max="100" required style="flex:2;">
          <select id="brancheSelect" name="branche" required style="flex:3;">
            <option value="">‚Äì w√§hlen ‚Äì</option>
          </select>
        </div>
        <div class="form-group">
          <textarea name="regionen" placeholder="Regionen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielgruppen" placeholder="Zielgruppen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="produkte" placeholder="Produkte / DL (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielsetzung" placeholder="Zielsetzung der Expos (z. B. 'Mehr Leads f√ºr regionale Dienstleistung')" rows="2"></textarea>
        </div>

        <div class="form-group tonality-container">
          <label class="tonality-label" for="tonality">Tonalit√§t</label>
          <input type="range" min="1" max="5" value="3" class="tonality-slider" id="tonality" name="tonality">
          <div class="tonality-value" id="tonality-value">Neutral</div>
        </div>

        <div class="form-group toggles-row">
          <div class="toggle-combo">
            <span class="toggle-label">Mit Ortsbezug</span>
            <label class="switch switch-small">
              <input type="checkbox" id="mitOrtsbezug" name="mitOrtsbezug" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-combo">
            <span class="toggle-label">Ansprache</span>
            <label class="switch switch-small">
              <input type="checkbox" id="ansprache" name="ansprache" checked>
              <span class="slider"></span>
            </label>
            <span class="toggle-label" id="ansprache-label">Du</span>
          </div>
        </div>

        <button class="btn-primary" type="submit">üöÄ Generieren</button>
      </form>
    </div>

    <!-- Output Panel -->
    <div class="output-panel" id="outputPanel">
      <h3 class="output-headline">üìù Generierte Expo-Titel</h3>
      <ul class="expo-list" id="expoList">
        <li class="expo-placeholder">Hier erscheinen deine generierten Expo-Titel...</li>
      </ul>
      <button id="exportBtn" class="btn-primary" style="margin-top:18px;display:none;">Export als CSV</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {

      /*************************************************
       *                KONSTANTEN                     *
       *************************************************/
      const tonalities = ['Locker','Eher locker','Neutral','Eher formell','Sehr formell'];
      const TITLE_START_URL = "https://expoya.app.n8n.cloud/webhook/start-job";
      const TITLE_POLL_URL  = "https://expoya.app.n8n.cloud/webhook/get-job?jobId=";
      const TEXT_WEBHOOK_URL= "https://expoya.app.n8n.cloud/webhook/bd470388-825f-417b-87c2-67bfee2c119f";

      const ladeFloskeln = [
        "Die AI-Agents h√ºpfen im Quadrat, um geile Titel zu basteln‚Ä¶",
        "Unsere KI brainstormt gerade die wildesten Expo-Ideen.",
        "Es werden noch schnell ein paar Synapsen poliert‚Ä¶",
        "Gleich sind die besten Titel aus dem neuronalen Backofen!",
        "Die k√ºnstliche Intelligenz schreibt schon am Bestseller.",
        "Wir optimieren noch f√ºr Google ‚Äì bitte einen kurzen Espresso trinken!",
        "Noch ein Moment: Kreativit√§t braucht manchmal eine kurze Denkpause.",
        "Die AI schraubt noch am SEO-Schraubenzieher.",
        "Expoya-Titelschmiede l√§uft auf Hochtouren!",
        "Wir w√ºrfeln noch ein paar W√∂rter zusammen‚Ä¶"
      ];

      /*************************************************
       *     GLOBALE STATE-VARIABLEN (Titel & Texte)   *
       *************************************************/
      let companyData     = {};      // gesammelt aus dem Formular
      let expoTitelArray  = [];      // [ "Titel1", "Titel2", ... ]
      let expoTextArray   = [];      // paralleles Array f√ºr Texte

      /*************************************************
       *        BRANCHENLISTE DYNAMISCH LADEN          *
       *************************************************/
      async function ladeBranchen(){
        const select = document.getElementById('brancheSelect');
        select.innerHTML = '<option value="">‚Äì w√§hlen ‚Äì</option>';
        try {
          const res = await fetch('assets/gmb_categories.json');
          if(!res.ok) throw new Error("JSON konnte nicht geladen werden");
          const cats = await res.json();
          cats.forEach(c=>{
            const o=document.createElement('option');o.value=c;o.textContent=c;select.appendChild(o);
          });
        } catch(err){
          ['Apotheke','Architekt','B√§ckerei'].forEach(c=>{
            const o=document.createElement('option');o.value=c;o.textContent=c;select.appendChild(o);
          });
          select.insertAdjacentHTML('beforebegin','<div style="color:#ff7070;font-size:13px;margin-bottom:3px;">Kategorien konnten nicht geladen werden.</div>');
        }
      }
      await ladeBranchen();

      /*************************************************
       *              UI-KLEINKRAM (Slider)            *
       *************************************************/
      document.getElementById('tonality').addEventListener('input',function(){
        document.getElementById('tonality-value').innerText = tonalities[this.value-1];
      });
      document.getElementById('ansprache').addEventListener('change',function(){
        document.getElementById('ansprache-label').innerText = this.checked?'Du':'Sie';
      });

      /*************************************************
       *            TITEL-GENERIERUNG (START)          *
       *************************************************/
      document.getElementById("myForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        /* 1) Daten sammeln */
        const fd = new FormData(this);
        companyData = Object.fromEntries(fd.entries());
        companyData.mitOrtsbezug = document.getElementById('mitOrtsbezug').checked;
        companyData.ansprache    = document.getElementById('ansprache').checked ? 'Du' : 'Sie';
        companyData.tonality     = tonalities[parseInt(fd.get('tonality')) - 1];

        /* 2) UI reset */
        const list = document.getElementById("expoList");
        list.innerHTML = '<li class="expo-placeholder">üöÄ Generierung l√§uft...</li>';
        document.getElementById('exportBtn').style.display = "none";

        /* 3) Job starten */
        let jobId;
        try{
          const r = await fetch(TITLE_START_URL,{
            method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(companyData)});
          const j = await r.json(); jobId = j.jobId;
          if(!jobId) throw new Error("Keine Job-ID zur√ºckbekommen");
        }catch(err){
          list.innerHTML='<li>Fehler: '+err.message+'</li>';return;
        }

        /* 4) Polling */
        const pollURL = TITLE_POLL_URL + encodeURIComponent(jobId);
        let tries=0,started=Date.now(); const maxTries=90;
        const timer = setInterval(async ()=>{
          tries++;
          const sec = Math.floor((Date.now()-started)/1000);
          const floskel = ladeFloskeln[Math.floor(sec/10)%ladeFloskeln.length];
          list.innerHTML = `<li class="expo-placeholder">üöÄ Generierung l√§uft... (${sec}s)<br><span style="font-size:0.95em;color:#98a4c2;">${floskel}</span></li>`;
          try{
            const r=await fetch(pollURL); const job=await r.json();
            if(job.status==="finished" && job.result){
              clearInterval(timer);
              expoTitelArray = JSON.parse(job.result);
              expoTextArray  = new Array(expoTitelArray.length).fill("");
              renderExpoListe();
            }
            if(job.status==="error"){
              clearInterval(timer);list.innerHTML='<li>Fehler: '+(job.error||"Unbekannter Fehler")+'</li>';
            }
          }catch(err){
            clearInterval(timer);list.innerHTML='<li>Polling-Fehler: '+err.message+'</li>';
          }
          if(tries>maxTries){
            clearInterval(timer);list.innerHTML='<li>Timeout: Generierung dauerte zu lange.</li>';
          }
        },10000);
      });

      /*************************************************
       *            TEXT-GENERIERUNG (EINZELN)         *
       *************************************************/
      async function generateText(idx){
        const btn = document.querySelector(`button.btn-generate[data-idx="${idx}"]`);
        if(!btn)return;
        btn.disabled=true; btn.textContent="‚è≥ L√§uft...";

        try{
          const payload={...companyData,h1Title:expoTitelArray[idx],expoIdx:idx};
          const r=await fetch(TEXT_WEBHOOK_URL,{
            method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
          if(!r.ok) throw new Error("Serverfehler "+r.status);
          const data=await r.json();
          if(!data.html) throw new Error("Keine Text-Antwort erhalten");
          expoTextArray[idx]=data.html;
          renderText(idx);
        }catch(err){alert("Fehler: "+err.message);}
        finally{btn.disabled=false;btn.textContent="Text generieren";}
      }

      /*************************************************
       *             LISTE & UI RENDERING              *
       *************************************************/
      function renderText(idx){
        const acc=document.querySelectorAll('.expo-akkordeon')[idx];
        const prev=acc.querySelector('.content-preview');
        const edt =acc.querySelector('.content-editor');
        const btnE=acc.querySelector('.btn-edit-content');
        const btnS=acc.querySelector('.btn-save-content');
        prev.innerHTML=expoTextArray[idx];
        prev.style.display="block";
        edt.style.display="none";
        btnS.style.display="none";
        btnE.style.display="inline-block";
      }

      function renderExpoListe(){
        const list=document.getElementById("expoList");
        list.innerHTML="";
        if(!expoTitelArray.length){
          list.innerHTML='<li class="expo-placeholder">Keine Titel mehr vorhanden.</li>';return;
        }

        expoTitelArray.forEach((titel,idx)=>{
          const hasText=!!expoTextArray[idx];
          const li=document.createElement("li");
          li.className="expo-akkordeon";
          li.innerHTML=`
          <div class="expo-akk-header" data-idx="${idx}">
            <span class="expo-akk-index">${idx+1}.</span>
            <span class="expo-akk-titel"><span class="expo-titel-text">${titel}</span></span>
            <button class="btn-icon btn-edit"   data-idx="${idx}" title="Titel bearbeiten">‚úèÔ∏è</button>
            <button class="btn-icon btn-delete" data-idx="${idx}" title="Entfernen">üóëÔ∏è</button>
            <button class="btn-expand"          data-idx="${idx}" title="Details">‚ñº</button>
          </div>
          <div class="expo-akk-body">
            <input  class="edit-titel-input" value="${titel}" style="display:none;">
            <div   class="akk-btns">
              <button class="btn-save"     style="display:none;" data-idx="${idx}">Speichern</button>
              <button class="btn-generate" data-idx="${idx}">Text generieren</button>
            </div>

            <!-- TEXT-BEREICH -->
            <div class="generated-section">
              <div class="content-preview" style="display:${hasText?'block':'none'};">${hasText?expoTextArray[idx]:""}</div>
              <textarea class="content-editor" style="display:none;width:100%;min-height:180px;"></textarea>
              <div class="content-buttons">
                <button class="btn-save-content" style="display:none;" data-idx="${idx}">Speichern</button>
                <button class="btn-edit-content" style="display:${hasText?'inline-block':'none'};" data-idx="${idx}">‚úèÔ∏è</button>
                <button class="btn-regenerate"   data-idx="${idx}">Neu generieren</button>
              </div>
            </div>
          </div>`;
          list.appendChild(li);
        });

        /* ---------- Akkordeon √∂ffnen/schlie√üen ---------- */
        list.querySelectorAll('.btn-expand').forEach(btn=>{
          btn.onclick=function(e){
            e.stopPropagation();
            const parent=btn.closest(".expo-akkordeon");
            const open=parent.classList.contains("open");
            list.querySelectorAll('.expo-akkordeon').forEach(el=>{
              el.classList.remove("open");
              el.querySelector('.btn-expand').textContent="‚ñº";
            });
            if(!open){parent.classList.add("open");btn.textContent="‚ñ≤";}
          };
        });

        /* ---------- Titel bearbeiten ---------- */
        list.querySelectorAll('.btn-edit').forEach(btn=>{
          btn.onclick=function(e){
            e.stopPropagation();
            const parent=btn.closest(".expo-akkordeon");
            parent.classList.add("open");
            parent.querySelector('.btn-expand').textContent="‚ñ≤";
            parent.querySelector('.edit-titel-input').style.display="inline";
            parent.querySelector('.btn-save').style.display="inline-block";
            parent.querySelector('.expo-titel-text').style.display="none";
            parent.querySelector('.edit-titel-input').focus();
          };
        });

        /* ---------- Titel speichern ---------- */
        list.querySelectorAll('.btn-save').forEach(btn=>{
          btn.onclick=function(e){
            e.stopPropagation();
            const idx=btn.dataset.idx;
            const parent=btn.closest(".expo-akkordeon");
            const val=parent.querySelector('.edit-titel-input').value.trim();
            if(!val.length)return;
            expoTitelArray[idx]=val;
            renderExpoListe();
            setTimeout(()=>{const acc=list.querySelectorAll('.expo-akkordeon')[idx];acc.classList.add("open");acc.querySelector('.btn-expand').textContent="‚ñ≤";},0);
          };
        });

        /* ---------- Titel l√∂schen ---------- */
        list.querySelectorAll('.btn-delete').forEach(btn=>{
          btn.onclick=function(e){
            e.stopPropagation();
            const idx=btn.dataset.idx;
            expoTitelArray.splice(idx,1);
            expoTextArray.splice(idx,1);
            renderExpoListe();
          };
        });

        /* ---------- Text generieren / regenerieren ---------- */
        list.querySelectorAll('.btn-generate').forEach(btn=>btn.onclick=e=>{
          e.stopPropagation();generateText(btn.dataset.idx);
        });
        list.querySelectorAll('.btn-regenerate').forEach(btn=>btn.onclick=e=>{
          e.stopPropagation();generateText(btn.dataset.idx);
        });

        /* ---------- Text editieren ---------- */
        list.querySelectorAll('.btn-edit-content').forEach(btn=>btn.onclick=e=>{
          e.stopPropagation();
          const idx=btn.dataset.idx;
          const acc=btn.closest(".expo-akkordeon");
          const prev=acc.querySelector('.content-preview');
          const edt =acc.querySelector('.content-editor');
          const btnS=acc.querySelector('.btn-save-content');
          prev.style.display="none";
          edt.style.display="block"; edt.value=expoTextArray[idx]; edt.focus();
          btnS.style.display="inline-block";
        });

        /* ---------- Text speichern (lokal) ---------- */
        list.querySelectorAll('.btn-save-content').forEach(btn=>btn.onclick=e=>{
          e.stopPropagation();
          const idx=btn.dataset.idx;
          const acc=btn.closest(".expo-akkordeon");
          const edt=acc.querySelector('.content-editor');
          expoTextArray[idx]=edt.value;
          renderText(idx);
          // ‚ûú Hier sp√§ter /save-expo-Webhook einbauen
        });

        /* ---------- CSV-Export anzeigen/verstecken ---------- */
        document.getElementById('exportBtn').style.display=expoTitelArray.length>0?"block":"none";
      }

      /*************************************************
       *              CSV-EXPORT-TITEL                 *
       *************************************************/
      document.getElementById('exportBtn').addEventListener('click',function(){
        if(!expoTitelArray.length)return;
        let csv='Expo-Titel\n';
        expoTitelArray.forEach(t=>csv+='"'+t.replace(/"/g,'""').replace(/\r?\n|\r/g,' ')+'"\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const link=document.createElement('a');
        link.href=URL.createObjectURL(blob); link.download='expo-titel.csv'; link.style.display='none';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
      });

    }); /* DOMContentLoaded */
  </script>
</body>
</html>
