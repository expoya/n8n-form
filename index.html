<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>AI-Content-Engine</title>
  <meta name="viewport" content="width=600, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Input Panel -->
    <div class="compact-panel">
      <img src="assets/logo.png" alt="Expoya Logo" class="logo">
      <h2 class="headline">AI-Content-Engine</h2>
      <form id="myForm" autocomplete="off">
        <div class="form-group">
          <input type="text" name="companyName" placeholder="Unternehmensname" required>
        </div>
        <div class="form-group">
          <input type="url" name="website" placeholder="Website">
        </div>
        <div class="form-row">
          <input type="number" name="expoCount" placeholder="# Expos" min="1" max="100" required style="flex:2;">
          <select id="brancheSelect" name="branche" required style="flex:3;">
            <option value="">‚Äì w√§hlen ‚Äì</option>
            <!-- Branchen werden via JS geladen -->
          </select>
        </div>
        <div class="form-group">
          <textarea name="regionen" placeholder="Regionen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielgruppen" placeholder="Zielgruppen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="produkte" placeholder="Produkte / DL (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielsetzung" placeholder="Zielsetzung der Expos (z.‚ÄØB. 'Mehr Leads f√ºr regionale Dienstleistung')" rows="2"></textarea>
        </div>
        <!-- Tonalit√§t Block -->
        <div class="form-group tonality-container">
          <label class="tonality-label" for="tonality">Tonalit√§t</label>
          <input type="range" min="1" max="5" value="3" class="tonality-slider" id="tonality" name="tonality">
          <div class="tonality-value" id="tonality-value">Neutral</div>
        </div>
        <!-- Toggles -->
        <div class="form-group toggles-row">
          <div class="toggle-combo">
            <span class="toggle-label">Mit Ortsbezug</span>
            <label class="switch switch-small">
              <input type="checkbox" id="mitOrtsbezug" name="mitOrtsbezug" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-combo">
            <span class="toggle-label">Ansprache</span>
            <label class="switch switch-small">
              <input type="checkbox" id="ansprache" name="ansprache" checked>
              <span class="slider"></span>
            </label>
            <span class="toggle-label" id="ansprache-label">Du</span>
          </div>
        </div>
        <button class="btn-primary" type="submit">üöÄ Generieren</button>
      </form>
    </div>

    <!-- Output Panel -->
    <div class="output-panel" id="outputPanel">
      <h3 class="output-headline">üìù Generierte Expo-Titel</h3>
      <ul class="expo-list" id="expoList">
        <li class="expo-placeholder">Hier erscheinen deine generierten Expo-Titel...</li>
      </ul>
      <button id="exportBtn" class="btn-primary" style="margin-top:18px;display:none;">Export als CSV</button>
    </div>
  </div>

  <script>
    // Branchen dynamisch aus JSON laden
    fetch('assets/gmb_categories.json')
      .then(response => response.json())
      .then(categories => {
        const select = document.getElementById('brancheSelect');
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
      })
      .catch(() => {
        // Fallback
        const select = document.getElementById('brancheSelect');
        ['Apotheke','Architekt','B√§ckerei'].forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
      });

    // Tonalit√§t
    const tonalities = ['Locker', 'Eher locker', 'Neutral', 'Eher formell', 'Sehr formell'];
    const tonalityInput = document.getElementById('tonality');
    const tonalityValue = document.getElementById('tonality-value');
    tonalityInput.addEventListener('input', function() {
      tonalityValue.innerText = tonalities[this.value - 1];
    });

    // Ansprache Toggle
    const anspracheInput = document.getElementById('ansprache');
    const anspracheLabel = document.getElementById('ansprache-label');
    anspracheInput.addEventListener('change', function() {
      anspracheLabel.innerText = this.checked ? 'Du' : 'Sie';
    });

    // Expo-Titel (CSV) ‚Äì speichern im Scope
    let expoTitelArray = [];

    // Flexibler Titel-Extractor
    function extractExpoTitel(result) {
  // direkte Arrays
  if (Array.isArray(result.titel_bisher) && result.titel_bisher.length > 0) {
    return result.titel_bisher;
  }
  if (Array.isArray(result.Titel) && result.Titel.length > 0) {
    return result.Titel;
  }
  // Output-Objekt
  if (result.output) {
    if (Array.isArray(result.output.titel_bisher) && result.output.titel_bisher.length > 0) {
      return result.output.titel_bisher;
    }
    if (Array.isArray(result.output.Titel) && result.output.Titel.length > 0) {
      return result.output.Titel;
    }
    if (Array.isArray(result.output.titel) && result.output.titel.length > 0) {
      return result.output.titel;
    }
  }
  return [];
}


    // Formular Handling
    document.getElementById("myForm").addEventListener("submit", async function(event) {
      event.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      data['mitOrtsbezug'] = document.getElementById('mitOrtsbezug').checked;
      data['ansprache'] = document.getElementById('ansprache').checked ? 'Du' : 'Sie';
      data['tonality'] = tonalities[parseInt(formData.get('tonality')) - 1];

      // UI-Feedback: Liste leeren + Placeholder setzen
      const list = document.getElementById("expoList");
      list.innerHTML = '';
      const liWait = document.createElement("li");
      liWait.textContent = "üöÄ Generierung l√§uft...";
      liWait.className = "expo-placeholder";
      list.appendChild(liWait);

      document.getElementById('exportBtn').style.display = "none";

      const webhookUrl = "https://expoya.app.n8n.cloud/webhook/03796224-cbe0-443a-adeb-e91f64514773";
      try {
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await response.json();

        list.innerHTML = "";
        expoTitelArray = [];

        const expoTitel = extractExpoTitel(result);

        if (expoTitel.length > 0) {
          expoTitel.forEach(titel => {
            const li = document.createElement("li");
            li.textContent = titel;
            list.appendChild(li);
            expoTitelArray.push(titel);
          });
          document.getElementById('exportBtn').style.display = "block";
        } else {
          const li = document.createElement("li");
          li.textContent = "Keine Titel erhalten.";
          li.className = "expo-placeholder";
          list.appendChild(li);
        }
      } catch (error) {
        list.innerHTML = "";
        const li = document.createElement("li");
        li.textContent = "Fehler: " + error.message;
        li.className = "expo-placeholder";
        list.appendChild(li);
      }
    });

    // CSV-Export-Funktion
    document.getElementById('exportBtn').addEventListener('click', function() {
      if (!expoTitelArray || expoTitelArray.length === 0) return;

      // Baue CSV
      let csv = 'Expo-Titel\n';
      expoTitelArray.forEach(titel => {
        // Escape quotes and line breaks for robust CSV
        let safeTitel = titel.replace(/"/g, '""').replace(/\r?\n|\r/g, ' ');
        csv += `"${safeTitel}"\n`;
      });

      // Download ausl√∂sen
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'expo-titel.csv';
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

  </script>
</body>
</html>
