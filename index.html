<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI-Content-Engine</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-200 font-sans text-[13px]">

  <div class="min-h-screen flex flex-col md:flex-row gap-6 p-4">

    <!-- Eingabe-Pane -->
    <aside class="md:w-80 w-full bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-4">
      <div class="text-center space-y-2">
        <img src="assets/logo.png" class="h-8 mx-auto" alt="Logo">
        <h1 class="text-xl font-bold text-indigo-400">AI-Content-Engine</h1>
      </div>

      <form id="form" class="space-y-3">

        <div><label class="block mb-0.5">Unternehmensname</label>
          <input name="companyName" required class="w-full bg-gray-700 border-gray-600 rounded px-2 py-1">
        </div>

        <div><label class="block mb-0.5">Website</label>
          <input name="website" type="url" required class="w-full bg-gray-700 border-gray-600 rounded px-2 py-1">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div><label class="block mb-0.5"># Expos</label>
            <input name="expoCount" type="number" min="1" required
                   class="w-full bg-gray-700 border-gray-600 rounded px-2 py-1">
          </div>
          <div><label class="block mb-0.5">Branche</label>
            <select name="branche" id="brancheSelect" required
                    class="w-full bg-gray-700 border-gray-600 rounded px-2 py-1">
              <option value="">– wählen –</option>
            </select>
          </div>
        </div>

        <div><label class="block mb-0.5">Regionen (, / ;)</label>
          <textarea name="regions" rows="2"
                    class="w-full bg-gray-700 border-gray-600 rounded px-2 py-1"
                    placeholder="OÖ; NÖ; Wien"></textarea></div>

        <div><label class="block mb-0.5">Zielgruppen (, / ;)</label>
          <textarea name="audiences" rows="2"
                    class="w-full bg-gray-700 border-gray-600 rounded px-2 py-1"
                    placeholder="Architekten; Bauträger"></textarea></div>

        <div><label class="block mb-0.5">Produkte / DL (, / ;)</label>
          <textarea name="offerings" rows="2"
                    class="w-full bg-gray-700 border-gray-600 rounded px-2 py-1"
                    placeholder="Fenster; Türen"></textarea></div>

        <!-- Toggle -->
        <div class="flex items-center justify-between">
          <span id="toggleLabel">Ohne Ortsbezug</span>
          <button type="button" id="toggle"
                  class="relative h-5 w-10 rounded-full bg-gray-600 transition-colors"
                  role="switch" aria-checked="false">
            <span id="knob"
                  class="absolute top-0.5 left-0.5 h-4 w-4 bg-white rounded-full
                         transform translate-x-0 transition-transform"></span>
          </button>
        </div>
        <input type="hidden" name="regional" id="regional" value="false">

        <button type="submit" id="submitBtn"
                class="w-full bg-indigo-600 hover:bg-indigo-700 py-1.5 rounded font-semibold text-sm flex items-center justify-center gap-1">
          <span id="btnIcon">🚀</span><span id="btnText">Generieren</span>
        </button>
      </form>
    </aside>

    <!-- Ausgabe-Pane -->
    <section class="flex-1 w-full bg-gray-800 border border-gray-700 rounded-xl p-4 flex flex-col">
      <header class="flex items-center justify-between mb-3">
        <h2 class="text-base font-semibold text-indigo-400">Titel-Liste</h2>
        <div id="counter" class="text-xs text-gray-400">0 / 0</div>
      </header>

      <ul id="titleList" class="flex-1 overflow-auto space-y-1 text-xs"></ul>

      <button id="fillBtn" disabled
              class="mt-3 self-end bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded text-xs font-semibold">
        ⟲ fehlende Titel nachgenerieren
      </button>
    </section>
  </div>

  <script>
    const api   = "https://expoya.app.n8n.cloud/webhook-test/03796224-cbe0-443a-adeb-e91f64514773";
    const $     = s => document.querySelector(s);

    /* --- Branchen laden --- */
    fetch('assets/gmb_categories.json')
      .then(r=>r.json())
      .then(a=>a.forEach(c=>$('#brancheSelect')
        .insertAdjacentHTML('beforeend',`<option>${c}</option>`)));

    /* --- Toggle --- */
    $('#toggle').onclick = () => {
      const t=$('#toggle'),k=$('#knob'),lbl=$('#toggleLabel'),hid=$('#regional');
      const on = t.getAttribute('aria-checked')==='true';
      t.setAttribute('aria-checked',(!on).toString());
      t.classList.toggle('bg-indigo-600',!on);
      t.classList.toggle('bg-gray-600', on);
      k.classList.toggle('translate-x-5',!on);
      k.classList.toggle('translate-x-0', on);
      lbl.textContent = !on ? 'Mit Ortsbezug' : 'Ohne Ortsbezug';
      hid.value       = (!on).toString();
    };

    /* --- State & Render --- */
    let wanted=0,titles=[];
    const render=()=>{
      $('#titleList').innerHTML = titles.length
        ? titles.map((t,i)=>
          `<li class="bg-gray-900 border border-gray-700 rounded flex justify-between px-2 py-0.5">
             <span class="truncate mr-1">${t}</span>
             <button data-i="${i}" class="text-red-400 hover:text-red-500">🗑︎</button>
           </li>`).join('')
        : '<li class="text-gray-500">Noch keine Titel …</li>';
      $('#counter').textContent = `${titles.length} / ${wanted}`;
      $('#fillBtn').disabled    = titles.length>=wanted;
    };
    $('#titleList').onclick=e=>{
      if(e.target.dataset.i){titles.splice(e.target.dataset.i,1);render();}
    };

    /* --- Nachgenerieren --- */
    $('#fillBtn').onclick=async()=>{
      const missing=wanted-titles.length;
      if(missing<=0)return;
      const res=await fetch(api,{method:'POST',
        body:new URLSearchParams({action:'fill',missing,existing:JSON.stringify(titles)})});
      titles=titles.concat(await res.json());
      render();
    };

    /* --- Submit --- */
    $('#form').onsubmit=async ev=>{
      ev.preventDefault();
      $('#submitBtn').disabled=true; $('#btnIcon').textContent='⏳'; $('#btnText').textContent='Lade…';

      const fd = Object.fromEntries(new FormData(ev.target).entries());
      ['regions','audiences','offerings'].forEach(k=>fd[k]=fd[k].split(/[;,]/).map(s=>s.trim()).filter(Boolean));
      fd.action='generate'; wanted=fd.expoCount;

      const res = await fetch(api,{method:'POST',body:new URLSearchParams(fd)});
      titles = await res.json().catch(()=>[]);
      render();

      $('#submitBtn').disabled=false; $('#btnIcon').textContent='🚀'; $('#btnText').textContent='Generieren';
    };
  </script>
</body>
</html>
