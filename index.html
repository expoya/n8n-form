<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>AI-Content-Engine</title>
  <meta name="viewport" content="width=600, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Input Panel -->
    <div class="compact-panel">
      <img src="assets/logo.png" alt="Expoya Logo" class="logo">
      <h2 class="headline">AI-Content-Engine</h2>
      <form id="myForm" autocomplete="off">
        <div class="form-group">
          <input type="text" name="companyName" placeholder="Unternehmensname" required>
        </div>
        <div class="form-group">
          <input type="url" name="website" placeholder="Website">
        </div>
        <div class="form-row">
          <input type="number" name="expoCount" placeholder="# Expos" min="1" max="100" required style="flex:2;">
          <select id="brancheSelect" name="branche" required style="flex:3;">
            <option value="">‚Äì w√§hlen ‚Äì</option>
          </select>
        </div>
        <div class="form-group">
          <textarea name="regionen" placeholder="Regionen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielgruppen" placeholder="Zielgruppen (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="produkte" placeholder="Produkte / DL (mit , oder ; trennen)" rows="1"></textarea>
        </div>
        <div class="form-group">
          <textarea name="zielsetzung" placeholder="Zielsetzung der Expos (z. B. 'Mehr Leads f√ºr regionale Dienstleistung')" rows="2"></textarea>
        </div>
        <div class="form-group tonality-container">
          <label class="tonality-label" for="tonality">Tonalit√§t</label>
          <input type="range" min="1" max="5" value="3" class="tonality-slider" id="tonality" name="tonality">
          <div class="tonality-value" id="tonality-value">Neutral</div>
        </div>
        <div class="form-group toggles-row">
          <div class="toggle-combo">
            <span class="toggle-label">Mit Ortsbezug</span>
            <label class="switch switch-small">
              <input type="checkbox" id="mitOrtsbezug" name="mitOrtsbezug" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-combo">
            <span class="toggle-label">Ansprache</span>
            <label class="switch switch-small">
              <input type="checkbox" id="ansprache" name="ansprache" checked>
              <span class="slider"></span>
            </label>
            <span class="toggle-label" id="ansprache-label">Du</span>
          </div>
        </div>
        <button class="btn-primary" type="submit">üöÄ Generieren</button>
      </form>
    </div>

    <!-- Output Panel -->
    <div class="output-panel" id="outputPanel">
      <h3 class="output-headline">üìù Generierte Expo-Titel</h3>
      <ul class="expo-list" id="expoList">
        <li class="expo-placeholder">Hier erscheinen deine generierten Expo-Titel...</li>
      </ul>
      <button id="exportBtn" class="btn-primary" style="margin-top:18px;display:none;">Export als CSV</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {

      /********************
       *  HILFSFUNKTIONEN *
       ********************/
      const tonalities = ['Locker','Eher locker','Neutral','Eher formell','Sehr formell'];
      const webhookURL  = "https://expoya.app.n8n.cloud/webhook/bd470388-825f-417b-87c2-67bfee2c119f";
      let   companyData = {};            // wird nach Titel-Generierung gesetzt
      let   expoTitelArray = [];         // Titel-Liste
      let   expoTextArray  = [];         // Texte parallel zu Titeln

      function sammleCompanyData(formEl) {
        const fd   = new FormData(formEl);
        const data = Object.fromEntries(fd.entries());
        data['mitOrtsbezug'] = document.getElementById('mitOrtsbezug').checked;
        data['ansprache']    = document.getElementById('ansprache').checked ? 'Du' : 'Sie';
        data['tonality']     = tonalities[parseInt(fd.get('tonality'))-1];
        return data;
      }

      /*********************************************
       *  ABSCHNITT 1 ‚Äì TITEL-GENERIERUNG (unver.) *
       *********************************************/
      // ... (unver√§nderter Code aus deiner Vorlage f√ºr Titel-Job)
      // => Am Ende von Titel-Generierung wird companyData gesetzt!
      //    und expoTitelArray + renderExpoListe() aufgerufen.

      /*******************************
       *  ABSCHNITT 2 ‚Äì TEXTE RUFEN  *
       *******************************/
      async function generateText(idx) {
        const btn = document.querySelector(`button.btn-generate[data-idx="${idx}"]`);
        if (!btn) return;
        btn.disabled = true;
        btn.textContent = "‚è≥ L√§uft...";
        const payload = {
          ...companyData,
          h1Title : expoTitelArray[idx],
          expoIdx : idx
        };
        try {
          const res  = await fetch(webhookURL, {
            method : "POST",
            headers: {"Content-Type":"application/json"},
            body   : JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Serverfehler");
          const data = await res.json();               // n8n liefert {html: "..."} o. √Ñ.
          if (!data.html) throw new Error("Kein Text erhalten");
          expoTextArray[idx] = data.html;
          renderText(idx);
        } catch (err) {
          alert("Fehler: " + err.message);
        } finally {
          btn.disabled   = false;
          btn.textContent = "Text generieren";
        }
      }

      function renderText(idx) {
        const acc     = document.querySelectorAll('.expo-akkordeon')[idx];
        const preview = acc.querySelector('.content-preview');
        const editor  = acc.querySelector('.content-editor');
        const btnSave = acc.querySelector('.btn-save-content');
        const btnEdit = acc.querySelector('.btn-edit-content');
        // Text anzeigen
        preview.innerHTML = expoTextArray[idx];
        preview.style.display = "block";
        btnEdit.style.display = "inline-block";
        // Editor schlie√üen, falls offen
        editor.style.display = "none";
        btnSave.style.display = "none";
      }

      /********************************************
       *  RENDEREXPOLISTE erweitert um Text-UI    *
       ********************************************/
      function renderExpoListe() {
        const list = document.getElementById("expoList");
        list.innerHTML = "";
        if (expoTitelArray.length === 0) {
          list.innerHTML = `<li class="expo-placeholder">Keine Titel mehr vorhanden.</li>`;
          document.getElementById('exportBtn').style.display = "none";
          return;
        }
        expoTitelArray.forEach((titel, idx) => {
          const textExist = !!expoTextArray[idx];
          const item = document.createElement("li");
          item.className = "expo-akkordeon";
          item.innerHTML = `
            <div class="expo-akk-header" data-idx="${idx}">
              <span class="expo-akk-index">${idx+1}.</span>
              <span class="expo-akk-titel"><span class="expo-titel-text">${titel}</span></span>
              <button class="btn-icon btn-edit" title="Titel bearbeiten" data-idx="${idx}">‚úèÔ∏è</button>
              <button class="btn-icon btn-delete" title="Entfernen" data-idx="${idx}">üóëÔ∏è</button>
              <button class="btn-expand" title="Details anzeigen" data-idx="${idx}">‚ñº</button>
            </div>
            <div class="expo-akk-body">
              <input class="edit-titel-input" value="${titel}" style="display:none;">
              <div class="akk-btns">
                <button class="btn-save" style="display:none;" data-idx="${idx}">Speichern</button>
                <button class="btn-generate" data-idx="${idx}">Text generieren</button>
              </div>
              <!-- ===== TEXT-ABSCHNITT ===== -->
              <div class="generated-section">
                <div class="content-preview" style="display:${textExist?'block':'none'};">${textExist?expoTextArray[idx]:'&nbsp;'}</div>
                <textarea class="content-editor" style="display:none;width:100%;min-height:180px;"></textarea>
                <div class="content-buttons">
                  <button class="btn-save-content" style="display:none;" data-idx="${idx}">Speichern</button>
                  <button class="btn-edit-content" style="display:${textExist?'inline-block':'none'};" data-idx="${idx}">‚úèÔ∏è</button>
                  <button class="btn-regenerate" data-idx="${idx}">Neu generieren</button>
                </div>
              </div>
            </div>
          `;
          list.appendChild(item);
        });

        /* ---------- vorhandene Handler (Titellogik) bleiben unver√§ndert ---------- */
        // ... (Accordion, Titel-Edit, Delete, Save) ...

        /* ---------- TEXT-BUTTONS ---------- */
        list.querySelectorAll('.btn-generate').forEach(btn=>{
          btn.onclick = e=>{
            e.stopPropagation();
            const idx = btn.getAttribute("data-idx");
            generateText(idx);
          };
        });

        list.querySelectorAll('.btn-regenerate').forEach(btn=>{
          btn.onclick = e=>{
            e.stopPropagation();
            const idx = btn.getAttribute("data-idx");
            generateText(idx);                      // einfach nochmal rufen
          };
        });

        list.querySelectorAll('.btn-edit-content').forEach(btn=>{
          btn.onclick = e=>{
            e.stopPropagation();
            const idx    = btn.getAttribute("data-idx");
            const acc    = btn.closest(".expo-akkordeon");
            const ed     = acc.querySelector('.content-editor');
            const prev   = acc.querySelector('.content-preview');
            const btnSave= acc.querySelector('.btn-save-content');
            prev.style.display  = "none";
            ed.style.display    = "block";
            btnSave.style.display="inline-block";
            ed.value = expoTextArray[idx] || '';
            ed.focus();
          };
        });

        list.querySelectorAll('.btn-save-content').forEach(btn=>{
          btn.onclick = e=>{
            e.stopPropagation();
            const idx  = btn.getAttribute("data-idx");
            const acc  = btn.closest(".expo-akkordeon");
            const ed   = acc.querySelector('.content-editor');
            expoTextArray[idx] = ed.value;
            renderText(idx);                        // aktualisierte Ansicht
            // TODO: hier sp√§ter /save-expo Call hinzuf√ºgen
          };
        });

        document.getElementById('exportBtn').style.display = expoTitelArray.length>0?"block":"none";
      }

      /*****************************************************
       *  FORM-SUBMIT √ºberschreiben (TITEL-JOB wie bisher) *
       *****************************************************/
      document.getElementById("myForm").addEventListener("submit", async function(event) {
        event.preventDefault();
        /* --------- hier bleibt dein vorhandener Code unver√§ndert ---------- */
        /* --------- wichtig: companyData setzen! ---------- */
        companyData = sammleCompanyData(this);
        /* --------- danach: expoTitelArray f√ºllen + renderExpoListe() ---------- */
        /* (dein Originalcode ruft renderExpoListe() ja sowieso auf) */
      });

      /****************** INITIALISIERUNG ******************/
      // Branchen laden usw. (dein vorhandener Code bleibt)
      async function ladeBranchen(){/* unver√§ndert */} await ladeBranchen();
      // Tonalit√§t-Slider, Du/Sie-Toggle ‚Äì unver√§ndert

    }); /* DOMContentLoaded */
  </script>
</body>
</html>
